<!DOCTYPE html>
<html>
<head> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<meta name="viewport" content="width=device-width, user-scalable=0, initial-scale=1.0, maximum-scale=1.0;" />
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){

      window.URL = window.URL || window.webkitURL;
      $("#stopButton").hide();
      $("#startButton").hide();

      $("#uploadButton").click(function(e) {
          e.preventDefault();
          $("#fileChoose0").click();
      });

      $("#fileChoose0").live('change', function() {
         $("#infoDiv").hide();
         var req = new XMLHttpRequest();
         req.open("POST", "uppp.php", true);
         req.onload = function(event) { 
            if (req.readyState === 4) {  
               if (req.status === 200) {  
                  console.log(req.responseText);
                  var au = document.getElementById('audio1');
                  var rsp = JSON.parse(req.responseText);
                  $("#resImage").attr("src", rsp.img);
                  au.src = rsp.snd;
                  au.load();
                  au.play();
                  $("#stopButton").show();
                  $("#startButton").show();
               } else {  
                  var msg = req.statusText + "\r\n" + req.responseText;
                  console.log("Error", msg);  
                  alert(msg);
               }  
            }  
         };

         // send conversion parameters in form data
         $("#negateFlag").attr("value", localStorage.getItem("negate"));
         $("#simplify").attr("value", localStorage.getItem("simplify"));

         var form = document.forms.namedItem("uploadForm");
//console.log(form);

         var fd = new FormData(form); 
         req.send(fd);

          $.each(this.files, function (i,file){
            if (!file.type.match(/image.*/)) {
              return;
            }

            var reader = new FileReader();
            reader.onload = (function(theFile) {
              return function(e) {
                 $("#srcImage").attr("data-file", theFile);
                 $("#srcImage").attr("title", theFile.name);
                 $("#srcImage").attr("src", e.target.result);
              };
            })(file);
            // Read in the image file as a data URL.
            reader.readAsDataURL(file);
          });

      });

      $("#stopButton").click(function(e) {
          e.preventDefault();
          document.getElementById('audio1').pause();
      });

      $("#startButton").click(function(e) {
          e.preventDefault();
          document.getElementById('audio1').play();
      });

      $("#cameraButton").click(function(e) {
          alert("Not implemented yet");
      });

      $("#saveButton").click(function(e) {
          e.preventDefault();
          if (document.getElementById("negateCheck").checked) {
             localStorage.negate = "yes";
	   } else {
             localStorage.negate = "no";
          }

          if (document.getElementById("simplifyCheck").checked) {
             localStorage.simplify = "yes";
	   } else {
             localStorage.simplify = "no";
          }
      });

      function restoreOptions() { 
          document.getElementById("negateCheck").checked = localStorage.negate == "yes";
          document.getElementById("simplifyCheck").checked = localStorage.simplify == "yes";
      }

      $("#cancelButton").click(function(e) {
          e.preventDefault();
	   restoreOptions();
          $("#negateCheck").checkboxradio('refresh');
          $("#simplifyCheck").checkboxradio('refresh');
      });

      $("#optionsButton").click(function(e) {
          e.preventDefault();
	   restoreOptions();
      });

      // restore conversion options when the page is loaded
      restoreOptions(); 
});
</script>

<title>Mobile Bitmaps and Waves</title> 
</head> 
 
<body>
<div data-role="page" id="home" name="home">
   <div align="center">
      <a id="adButton" data-inline="false" data-role="button" 
         href="http://victorx.eu" data-theme="a" data-corners="false">
         Bitmaps and Waves</a>
   </div><!-- header -->

   <div align="center" data-role="content">
      <div align="center" id="infoDiv">
        This service converts images to sounds.
      </div> <!-- info text -->

      <img id="srcImage" alt="" width="200px"/>
      <img id="resImage" alt="" width="200px"/>

      <audio id="audio1" preload="auto">AUDIO</audio>
      <form id="uploadFormPost" name="uploadForm" 
            enctype="multipart/form-data" action="uppp.php" method="POST" 
            data-ajax='false'>
         <input type="hidden" name="MAX_FILE_SIZE" value="400000" />
         <input type="hidden" name="negate" id="negateFlag" value="yes" />
         <input type="hidden" name="simplify" id="simplify" value="yes" />
         <input type="file" id="fileChoose0" name="uploadedfile" 
            multiple="false" accept="image/jpeg" style="height:0;width:0;"/>
      </form>
   </div> <!-- content -->

   <div data-role="footer" align="center">
      <a id="uploadButton" data-icon="arrow-u" data-inline="true" 
         data-role="button" data-theme="b" 
         data-iconpos="left">Upload an Image File</a>
      <!--a id="cameraButton" data-inline="true" data-role="button" 
         data-theme="b" data-iconpos="left">Take a Picture</a -->
      <a id="startButton" data-icon="arrow-r" data-inline="true" 
         data-role="button" data-theme="b" data-iconpos="left">Play</a>
      <a id="stopButton" data-icon="delete" data-inline="true" 
         data-role="button" data-theme="b" data-iconpos="left">Stop</a>
      <a href="#options" id="optionsButton" data-icon="gear" data-inline="true"
         data-role="button" data-theme="b">Options</a>
   </div> <!-- footer -->
</div> <!-- home page-->

<div data-role="page" id="options" name="options">
   <div align="center">
      <a id="adButton" data-inline="false" data-role="button" 
         href="http://victorx.eu" data-theme="a" data-corners="false">
         Bitmaps and Waves</a>
   </div><!-- header -->

   <div data-role="content" align="center">

<fieldset data-role="controlgroup" data-role="fieldcontain" data-type="vertical" data-mini="false">
<input type="checkbox" name="simplifyCheck" id="simplifyCheck" "/>
<label for="simplifyCheck">Simplify image</label>
<input type="checkbox" name="negateCheck" id="negateCheck"/>
<label for="negateCheck">Negate image</label>
</fieldset>
   </div> <!-- content -->

   <div data-role="footer" align="center">
      <a href="#home" id="cancelButton" data-icon="cancel" data-role="button"
         data-inline="true" data-theme="b">Cancel</a>
      <a href="#home" id="saveButton" data-icon="check" data-role="button"
         data-inline="true" data-theme="b">Save</a>
   </div> <!-- footer -->
</div> <!-- options page-->

</body>
</html>
